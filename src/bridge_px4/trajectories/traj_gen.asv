clear

% Parameters
Ndr = 4;     % Number of Drones.
T  = 10;    % Total Time for Trajectory.
dt = 0;     % Frame Step. Set to 0 if you want to follow raw waypoints.
R  = 1.5;   % Radius of formation (assumed circular)

% Trajectory
P = [ 1.0   1.0  -1.0  -1.0   1.0;
     -1.0   1.0   1.0  -1.0  -1.0; 
      1.0   1.0   1.0   1.0   1.0];

% Pre-processing
angle = 2*pi/Ndr;
Nfr = size(P,2);
Dt = round(T/Nfr,2);

if (dt == 0)
    traj = zeros(3*Ndr+1,Nfr);

    for k = 1:Nfr
        t = k*dt;
        traj(1,k) = t;
        traj(2:end,k) = swarm_setpoint(P(:,k),R,Ndr,angle);
    end
end

liveplot(P,traj,Ndr,Nfr)

function X = swarm_setpoint(P,R,N,angle)
    X = zeros(3*N,1);
    
    for k = 1:N
        idx = 1+(k-1)*3;
        theta = (k-1)*angle;
        
        X(idx:idx+2,:) = P + R.*[cos(theta) ; sin(theta) ; 0.0];
    end
end

function liveplot(P,traj,Ndr,Nfr)

figure(1)
clf

% Plot the center line
plot3(P(1,:),P(2,:),P(3,:),'k--');
xlim([-3.0 3.0]);
ylim([-8.0 8.0]);
zlim([ 0.0 3.0]);
daspect([1 1 1])
hold on


% Plot the initial points
for k = 1:Ndr
    idx = 2+(k-1)*3;
    h(k) = plot3(traj(idx,1),traj(idx+1,1),traj(idx+2,1),'*-');
end
pause(1);

    curr_time = dt;
    while (curr_time <= t_act(end))
        tic
        k = ceil(curr_time/dt);
        
        [x_arrow, y_arrow, z_arrow] = frame_builder(x_act(:,k));
        h_persp = reassign(h_persp,x_arrow,y_arrow,z_arrow);
        
        if t_act(k) > flight.t_capture
            h_targ.XData = x_act(1,k);
            h_targ.YData = x_act(2,k);
            h_targ.ZData = x_act(3,k)-0.1;
        end
        
        drawnow
        
        curr_time = curr_time + toc;
    end
    
for j = 1:Nfr
    for k = 1:Ndr
        idx = 2+(k-1)*3;
        h(k).XData = traj(idx,1:j);
        h(k).YData = traj(idx+1,1:j);
        h(k).ZData = traj(idx+2,1:j);
    end
    pause(1);
end

end